(function(){CKEDITOR.plugins.add("pwimage",{requires:"dialog",init:function(c){var d="pwimage";var f="img[alt,id,!src,title,width](align_left,align_center,align_right,hidpi,align-left,align-center,align-right);a[!href];figure{width}(align_left,align_center,align_right,hidpi,align-left,align-center,align-right);figcaption;";var e="img[alt,src]";c.addCommand(d,{allowedContent:f,requiredContent:e,exec:b});c.ui.addButton("PWImage",{label:c.lang.common.image,command:d,hidpi:true,icon:(CKEDITOR.env.hidpi?this.path+"images/hidpi/pwimage.png":this.path+"images/pwimage.png")});c.on("doubleclick",function(g){var h=g.data.element;if((h.is("img"))&&!h.data("cke-realelement")&&!h.isReadOnly()){g.cancel();c.commands.pwimage.exec()}});if(c.addMenuItems){c.addMenuItems({image:{label:c.lang.image.menu,command:"pwimage",group:"image"}})}if(c.contextMenu){c.contextMenu.addListener(function(g,h){if(a(c,g)){return{image:CKEDITOR.TRISTATE_OFF}}})}}});function a(d,c){if(!c){var e=d.getSelection();c=e.getSelectedElement()}if(c&&c.is("img")&&!c.data("cke-realelement")&&!c.isReadOnly()){return c}}function b(h){var o=jQuery("#Inputfield_id");if(o.length){var p=o.val()}else{var p=jQuery("#"+h.name).closest(".Inputfield").attr("data-pid")}var j=p;var B="";var k="";var s=0;var A=0;var y="";var i="";var c=false;var E=h.getSelection();var F=E.getSelectedElement();var z=E.getStartElement();var C=jQuery(z);var g=z.getParent();var r=g.getParent();var m=C.attr("src");var q=null;var D=null;var v=null;var e=g.$.nodeName.toUpperCase();var l=r?r.$.nodeName.toUpperCase():"";E.lock();h.lockSelection();if(l=="FIGURE"){D=jQuery(r.getOuterHtml());v=D.find("figcaption");D.find("img").remove()}else{if(e=="FIGURE"){D=jQuery(g.getOuterHtml());v=D.find("figcaption");D.find("img").remove()}}if(e==="A"){q=jQuery(g.getOuterHtml());q.find("img").remove()}if(m){k=D?D.attr("class"):C.attr("class");c=k&&k.indexOf("hidpi")>-1;s=C.attr("width");A=C.attr("height");y=C.attr("alt");i=e==="A"?g.$.href:"";var x=m.split("/");B=x.pop();x=x.reverse();p="";for(var w=0;w<x.length;w++){if(x[w].match(/^\d+$/)){p=x[w]+p}else{if(p.length){break}}}p=parseInt(p)}var t=ProcessWire.config.urls.admin+"page/image/";var f="?id="+p+"&edit_page_id="+j+"&modal=1";if(B.length){f+="&file="+B}if(s){f+="&width="+s}if(A){f+="&height="+A}if(k&&k.length){f+="&class="+encodeURIComponent(k)}f+="&hidpi="+(c?"1":"0");if(y&&y.length){f+="&description="+encodeURIComponent(y)}if(v){f+="&caption=1"}if(i&&i.length){f+="&link="+encodeURIComponent(i)}f+=("&winwidth="+(jQuery(window).width()-30));var d={title:"<i class='fa fa-fw fa-folder-open'></i> "+ProcessWire.config.InputfieldCKEditor.pwimage.selectLabel,open:function(){if(jQuery(".cke_maximized").length>0){jQuery(".ui-dialog").css("z-index",9999);jQuery(".ui-widget-overlay").css("z-index",9998)}}};var u=pwModalWindow(t+f,d,"large");u.load(function(){var H=u.contents();if(H.find("#selected_image").size()>0){var n=[{html:"<i class='fa fa-camera'></i> "+ProcessWire.config.InputfieldCKEditor.pwimage.insertBtn,click:function(){function N(T){var ad=u.contents();var U=jQuery("#selected_image",ad);var V=U.attr("width");var ae=U.attr("height");var Z=jQuery("#selected_image_description",ad).val();var ag=jQuery("#selected_image_caption",ad).is(":checked")?true:false;var ac=jQuery("#selected_image_hidpi",ad).is(":checked")?true:false;var af=U.removeClass("ui-resizable No Alignment resizable_setup").removeClass("rotate90 rotate180 rotate270 rotate-90 rotate-180 rotate-270").removeClass("flip_vertical flip_horizontal").attr("class");var S=jQuery("#selected_image_link",ad);var aa=S.is(":checked")?S.val():"";var ab=jQuery("<img />").attr("src",T).attr("alt",Z);if(ac){af+=(af.length>0?" ":"")+"hidpi"}if(ag===false){ab.addClass(af)}if(V>0){ab.attr("width",V)}if(q){if(aa&&aa.length>0){q.attr("href",aa).attr("data-cke-saved-href",aa)}else{if(S.attr("data-was-checked")==1){q=null}}if(q!==null){q.append(ab);ab=q}}else{if(aa&&aa.length>0){var X=jQuery("<a />").attr("href",aa).append(ab);ab=X}}if(ag){var W=jQuery("<figure />");if(af.length){W.addClass(af)}if(!v){v=jQuery("<figcaption />");if(Z.length>1){v.append(Z)}else{v.append(ProcessWire.config.InputfieldCKEditor.pwimage.captionLabel)}}if(v){W.append(v)}W.prepend(ab);ab=W}h.unlockSelection();E.unlock();if(l==="FIGURE"){E.selectElement(r)}else{if(e==="A"||e=="FIGURE"){E.selectElement(g)}}var Y=ab[0].outerHTML;h.insertHtml(Y);h.fire("change");u.dialog("close")}var P=u.contents();var I=jQuery("#selected_image",P);u.dialog("disable");u.setTitle("<i class='fa fa-fw fa-spin fa-spinner'></i> "+ProcessWire.config.InputfieldCKEditor.pwimage.savingNote);I.removeClass("resized");var J=I.attr("width");if(!J){J=I.width()}var Q=I.attr("height");if(!Q){Q=I.height()}var K=I.attr("src");var R=jQuery("#page_id",P).val();var O=jQuery("#selected_image_hidpi",P).is(":checked")?1:0;var M=parseInt(jQuery("#selected_image_rotate",P).val());K=K.substring(K.lastIndexOf("/")+1);var L=t+"resize?id="+R+"&file="+K+"&width="+J+"&height="+Q+"&hidpi="+O;if(M){L+="&rotate="+M}if(I.hasClass("flip_horizontal")){L+="&flip=h"}else{if(I.hasClass("flip_vertical")){L+="&flip=v"}}jQuery.get(L,function(T){var S=jQuery("<div></div>").html(T);var U=S.find("#selected_image").attr("src");N(U)})}},{html:"<i class='fa fa-folder-open'></i> "+ProcessWire.config.InputfieldCKEditor.pwimage.selectBtn,"class":"ui-priority-secondary",click:function(){var J=u.contents();var I=jQuery("#page_id",J).val();u.attr("src",t+"?id="+I+"&modal=1");u.setButtons({})}},{html:"<i class='fa fa-times-circle'></i> "+ProcessWire.config.InputfieldCKEditor.pwimage.cancelBtn,"class":"ui-priority-secondary",click:function(){u.dialog("close")}}];u.setButtons(n);u.setTitle("<i class='fa fa-fw fa-picture-o'></i> "+H.find("title").html())}else{var n=[];jQuery("button.pw-modal-button, button[type=submit]:visible",H).each(function(){var J=jQuery(this);var I={html:J.html(),click:function(){J.click()}};n.push(I);if(!J.hasClass("pw-modal-button-visible")){J.hide()}});var G={html:"<i class='fa fa-times-circle'></i> "+ProcessWire.config.InputfieldCKEditor.pwimage.cancelBtn,"class":"ui-priority-secondary",click:function(){u.dialog("close")}};n.push(G);u.setButtons(n)}})}})();
!function(){function e(e){function n(){var n=C.contents(),i=jQuery(jQuery("#link_markup",n).text());if(i.attr("href")&&i.attr("href").length){i.text().length||i.html(d);var t=jQuery("<div />").append(i).html();e.insertHtml(t)}C.dialog("close")}var i=jQuery("#Inputfield_id");if(i.length)var t=i.val();else var t=jQuery("#"+e.name).closest(".Inputfield").attr("data-pid");var l=jQuery("#"+e.name),a=e.getSelection(!0),r=a.getStartElement(),o=r.getName(),d=a.getSelectedText(),c=null,u=CKEDITOR.plugins.link.getEditorAnchors(e);if("a"==o)c=jQuery(r.$),d=r.getHtml(),a.selectElement(r);else if("img"==o){var s=jQuery(r.$);c=s.parent("a"),d=r.$.outerHTML}else if(d.length<1)return;var m=ProcessWire.config.urls.admin+"page/link/?id="+t+"&modal=1",g=l.closest(".LanguageSupport");if(g.length&&(m+="&lang="+g.data("language")),null!=c)for(var p=["href","title","class","rel","target"],k=0;k<p.length;k++){var h=c.attr(p[k]);h&&h.length&&(m+="&"+p[k]+"="+encodeURIComponent(h))}if(u.length>0)for(var k=0;k<u.length;k++)m+="&anchors[]="+encodeURIComponent(u[k].id);var f=c&&c.text().length?c.text():d;"img"!==o&&f.length&&(m+="&text="+encodeURIComponent(f));var C,v=ProcessWire.config.InputfieldCKEditor.pwlink.label,w=ProcessWire.config.InputfieldCKEditor.pwlink.cancel,y={title:"<i class='fa fa-link'></i> "+v,open:function(){jQuery(".cke_maximized").length>0&&(jQuery(".ui-dialog").css("z-index",9999),jQuery(".ui-widget-overlay").css("z-index",9998))},buttons:[{"class":"pw_link_submit_insert",html:"<i class='fa fa-link'></i> "+v,click:n},{html:"<i class='fa fa-times-circle'></i> "+w,click:function(){C.dialog("close")},"class":"ui-priority-secondary"}]},C=pwModalWindow(m,y,"medium");C.load(function(){var e=C.contents();e.find("#ProcessPageEditLinkForm").data("iframe",C),jQuery("#link_page_url",e).keydown(function(e){var i=jQuery(this),t=jQuery.trim(i.val());return 13==e.keyCode?(e.preventDefault(),t.length>0&&n(),!1):void 0})})}CKEDITOR.plugins.add("pwlink",{requires:"dialog,fakeobjects",init:function(n){var i="a[!href,target,name,title,rel]",t="a[href]",l=ProcessWire.config.InputfieldCKEditor.pwlink.classOptions;l.length&&(i+="("+l+")"),n.addCommand("pwlink",{allowedContent:i,requiredContent:t,exec:e}),n.addCommand("anchor",new CKEDITOR.dialogCommand("anchor",{allowedContent:"a[!name,id]",requiredContent:"a[name]"})),n.addCommand("unlink",new CKEDITOR.unlinkCommand),n.addCommand("removeAnchor",new CKEDITOR.removeAnchorCommand),n.setKeystroke(CKEDITOR.CTRL+76,"pwlink"),n.ui.addButton&&(n.ui.addButton("PWLink",{label:n.lang.link.toolbar,command:"pwlink",toolbar:"links,10",hidpi:!0,icon:CKEDITOR.env.hidpi?this.path+"images/hidpi/pwlink.png":this.path+"images/pwlink.png"}),n.ui.addButton("Unlink",{label:n.lang.link.unlink,command:"unlink",toolbar:"links,20"}),n.ui.addButton("Anchor",{label:n.lang.link.anchor.toolbar,command:"anchor",toolbar:"links,30"})),n.on("doubleclick",function(e){var i=CKEDITOR.plugins.link.getSelectedLink(n)||e.data.element;if(i.is("a")&&!i.getAttribute("name")&&!i.isReadOnly()){var t=jQuery(i.$);0==t.children("img").length&&(e.cancel(),n.commands.pwlink.exec())}}),n.on("instanceReady",function(e){e.editor.removeMenuItem("link")}),n.contextMenu&&(n.addMenuItem("pwlinkitem",{label:ProcessWire.config.InputfieldCKEditor.pwlink.edit,command:"pwlink",group:"link",icon:CKEDITOR.env.hidpi?this.path+"images/hidpi/pwlink.png":this.path+"images/pwlink.png"}),n.contextMenu.addListener(function(e){if(!e||e.isReadOnly())return null;var i=CKEDITOR.plugins.link.tryRestoreFakeAnchor(n,e),t={};return i||(i=CKEDITOR.plugins.link.getSelectedLink(n))?(i.getAttribute("href")&&i.getChildCount()&&(t={pwlinkitem:CKEDITOR.TRISTATE_OFF}),t):null}))}})}();